<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic P2P Shooter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            background: linear-gradient(45deg, #0a0a2a, #1a1a4a, #2a2a6a);
        }
        
        #stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .container {
            position: relative;
            z-index: 2;
        }
        
        /* –õ–æ–±–±–∏ */
        #lobby {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .lobby-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 800px;
            text-align: center;
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        
        .ship-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .ship-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ship-card:hover {
            border-color: #4ecdc4;
            transform: translateY(-5px);
        }
        
        .ship-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }
        
        .ship-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .ship-stats {
            font-size: 0.8em;
            color: #ccc;
        }
        
        .stat-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 2px 0;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            background: #4ecdc4;
            border-radius: 2px;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
        #gameArea {
            display: none;
        }
        
        #gameCanvas {
            display: block;
            background: rgba(0, 0, 0, 0.3);
        }
        
        #gameUI {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .player-info {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .health-bar {
            width: 200px;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        #gameCode {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .controls-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9em;
        }
        
        .connection-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .status-connected {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4caf50;
        }
        
        .status-disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        
        .status-connecting {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #ff9800;
        }
    </style>
</head>
<body>
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω –∑–≤–µ–∑–¥ -->
    <canvas id="stars"></canvas>
    
    <div class="container">
        <!-- –õ–æ–±–±–∏ -->
        <div id="lobby">
            <div class="lobby-content">
                <h1>üöÄ COSMIC P2P SHOOTER</h1>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ –∫–æ—Å–º–∏—á–µ—Å–∫—É—é –±–∏—Ç–≤—É!</p>
                
                <div id="connectionStatus" class="connection-status status-disconnected">
                    ‚ùå –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...
                </div>
                
                <div class="ship-selection">
                    <!-- –ö–æ—Ä–∞–±–ª—å 1: –°–∫–æ—Ä–æ—Å—Ç–Ω–æ–π -->
                    <div class="ship-card" onclick="selectShip(0)">
                        <div class="ship-icon">üöÄ</div>
                        <h3>–°—Ç—Ä–∏–∂</h3>
                        <div class="ship-stats">
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: <div class="stat-bar"><div class="stat-fill" style="width: 90%"></div></div></div>
                            <div>–ê—Ç–∞–∫–∞: <div class="stat-bar"><div class="stat-fill" style="width: 60%"></div></div></div>
                            <div>–ó–∞—â–∏—Ç–∞: <div class="stat-bar"><div class="stat-fill" style="width: 40%"></div></div></div>
                        </div>
                    </div>
                    
                    <!-- –ö–æ—Ä–∞–±–ª—å 2: –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π -->
                    <div class="ship-card" onclick="selectShip(1)">
                        <div class="ship-icon">üõ∏</div>
                        <h3>–ì–∞—Ä–ø—É–Ω</h3>
                        <div class="ship-stats">
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: <div class="stat-bar"><div class="stat-fill" style="width: 70%"></div></div></div>
                            <div>–ê—Ç–∞–∫–∞: <div class="stat-bar"><div class="stat-fill" style="width: 70%"></div></div></div>
                            <div>–ó–∞—â–∏—Ç–∞: <div class="stat-bar"><div class="stat-fill" style="width: 70%"></div></div></div>
                        </div>
                    </div>
                    
                    <!-- –ö–æ—Ä–∞–±–ª—å 3: –¢–∞–Ω–∫ -->
                    <div class="ship-card" onclick="selectShip(2)">
                        <div class="ship-icon">üõ∞Ô∏è</div>
                        <h3>–¢–∏—Ç–∞–Ω</h3>
                        <div class="ship-stats">
                            <div>–°–∫–æ—Ä–æ—Å—Ç—å: <div class="stat-bar"><div class="stat-fill" style="width: 40%"></div></div></div>
                            <div>–ê—Ç–∞–∫–∞: <div class="stat-bar"><div class="stat-fill" style="width: 80%"></div></div></div>
                            <div>–ó–∞—â–∏—Ç–∞: <div class="stat-bar"><div class="stat-fill" style="width: 90%"></div></div></div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button id="createBtn" onclick="createGame()" disabled>–°–æ–∑–¥–∞—Ç—å –±–∏—Ç–≤—É</button>
                    <button id="joinBtn" onclick="showJoinForm()" disabled>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
                
                <div id="joinForm" style="display: none; margin-top: 20px;">
                    <input type="text" id="gameCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–∏—Ç–≤—ã" 
                           style="padding: 10px; border: none; border-radius: 5px; margin-right: 10px;">
                    <button id="joinGameBtn" onclick="joinGame()" disabled>–í–æ–π—Ç–∏ –≤ –±–∏—Ç–≤—É</button>
                </div>
            </div>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
        <div id="gameArea">
            <canvas id="gameCanvas" width="1200" height="800"></canvas>
            
            <div id="gameUI">
                <h3>‚ö° –°—Ç–∞—Ç—É—Å –±–∏—Ç–≤—ã</h3>
                <div id="player1Info" class="player-info">
                    –ò–≥—Ä–æ–∫ 1: <span id="p1Ship">-</span>
                    <div class="health-bar"><div id="p1Health" class="health-fill" style="width: 100%"></div></div>
                </div>
                <div id="player2Info" class="player-info">
                    –ò–≥—Ä–æ–∫ 2: <span id="p2Ship">-</span>
                    <div class="health-bar"><div id="p2Health" class="health-fill" style="width: 100%"></div></div>
                </div>
            </div>
            
            <div id="gameCode">
                <strong>–ö–æ–¥ –±–∏—Ç–≤—ã:</strong><br>
                <span id="gameCodeDisplay">-</span>
            </div>
            
            <div class="controls-info">
                <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong><br>
                WASD - –¥–≤–∏–∂–µ–Ω–∏–µ<br>
                Space - —Å—Ç—Ä–µ–ª—å–±–∞<br>
                Mouse - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω –∑–≤–µ–∑–¥
        class Starfield {
            constructor() {
                this.canvas = document.getElementById('stars');
                this.ctx = this.canvas.getContext('2d');
                this.stars = [];
                this.resize();
                this.init();
                
                window.addEventListener('resize', () => this.resize());
            }
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            init() {
                // –°–æ–∑–¥–∞–µ–º –∑–≤–µ–∑–¥—ã
                for (let i = 0; i < 200; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 2 + 1,
                        speed: Math.random() * 0.5 + 0.1,
                        brightness: Math.random()
                    });
                }
            }
            
            update() {
                this.ctx.fillStyle = 'rgba(10, 10, 42, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.stars.forEach(star => {
                    star.y += star.speed;
                    if (star.y > this.canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * this.canvas.width;
                    }
                    
                    // –ú–µ—Ä—Ü–∞–Ω–∏–µ
                    star.brightness += (Math.random() - 0.5) * 0.1;
                    star.brightness = Math.max(0.3, Math.min(1, star.brightness));
                    
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }
        }

        // –ò–≥—Ä–æ–≤–æ–π –¥–≤–∏–∂–æ–∫
        class CosmicShooter {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.peer = null;
                this.conn = null;
                this.gameId = null;
                this.selectedShip = 0;
                this.gameActive = false;
                this.isConnected = false;
                
                this.players = {};
                this.bullets = [];
                this.particles = [];
                
                this.keys = {};
                this.mouse = { x: 0, y: 0 };
                
                this.ships = [
                    { name: '–°—Ç—Ä–∏–∂', icon: 'üöÄ', speed: 5, attack: 3, defense: 2, color: '#ff6b6b' },
                    { name: '–ì–∞—Ä–ø—É–Ω', icon: 'üõ∏', speed: 4, attack: 4, defense: 4, color: '#4ecdc4' },
                    { name: '–¢–∏—Ç–∞–Ω', icon: 'üõ∞Ô∏è', speed: 2, attack: 5, defense: 6, color: '#45b7d1' }
                ];
                
                this.init();
            }
            
            init() {
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    if (e.key === ' ') {
                        e.preventDefault();
                        this.shoot();
                    }
                });
                document.addEventListener('keyup', (e) => this.keys[e.key.toLowerCase()] = false);
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouse.x = e.clientX - rect.left;
                    this.mouse.y = e.clientY - rect.top;
                });
                this.canvas.addEventListener('click', (e) => this.shoot());
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º —Å–∏–≥–Ω–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
                this.initializePeerJS();
                
                // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
                this.gameLoop();
            }
            
            initializePeerJS() {
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
                    this.peer = new Peer({
                        host: '0.peerjs.com',
                        port: 443,
                        path: '/',
                        debug: 3
                    });
                    
                    this.peer.on('open', (id) => {
                        console.log('Connected to PeerJS server with ID:', id);
                        this.isConnected = true;
                        this.updateConnectionStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É P2P', 'status-connected');
                        document.getElementById('createBtn').disabled = false;
                        document.getElementById('joinBtn').disabled = false;
                        document.getElementById('joinGameBtn').disabled = false;
                    });
                    
                    this.peer.on('error', (err) => {
                        console.error('PeerJS error:', err);
                        this.updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + err.type, 'status-disconnected');
                        this.isConnected = false;
                        
                        // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        setTimeout(() => {
                            this.initializePeerJS();
                        }, 3000);
                    });
                    
                    this.peer.on('connection', (conn) => {
                        console.log('Incoming connection from:', conn.peer);
                        this.conn = conn;
                        this.setupConnection();
                    });
                    
                } catch (error) {
                    console.error('Failed to initialize PeerJS:', error);
                    this.updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ P2P', 'status-disconnected');
                }
            }
            
            updateConnectionStatus(message, className) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = message;
                statusElement.className = `connection-status ${className}`;
            }
            
            createGame() {
                if (!this.isConnected) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É P2P');
                    return;
                }
                
                this.gameId = this.generateGameId();
                this.updateConnectionStatus('üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...', 'status-connecting');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                this.addPlayer(this.peer.id, this.selectedShip, true);
                
                document.getElementById('gameCodeDisplay').textContent = this.gameId;
                this.showGameArea();
            }
            
            joinGame(gameId) {
                if (!this.isConnected) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É P2P');
                    return;
                }
                
                this.gameId = gameId;
                this.updateConnectionStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...', 'status-connecting');
                
                try {
                    this.conn = this.peer.connect(gameId, {
                        reliable: true
                    });
                    
                    this.conn.on('open', () => {
                        console.log('Connected to peer:', gameId);
                        this.updateConnectionStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∏–≥—Ä–µ!', 'status-connected');
                        this.setupConnection();
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                        this.sendData({
                            type: 'player_join',
                            ship: this.selectedShip,
                            playerId: this.peer.id
                        });
                        
                        this.showGameArea();
                        document.getElementById('gameCodeDisplay').textContent = gameId;
                    });
                    
                    this.conn.on('error', (err) => {
                        console.error('Connection error:', err);
                        this.updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–≥—Ä–µ', 'status-disconnected');
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –∏–≥—Ä—ã.');
                    });
                    
                } catch (error) {
                    console.error('Join game error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –∏–≥—Ä–µ');
                }
            }
            
            setupConnection() {
                this.conn.on('data', (data) => this.handleData(data));
                this.conn.on('close', () => this.handleDisconnect());
                this.conn.on('error', (err) => console.error('Connection error:', err));
            }
            
            handleData(data) {
                console.log('Received data:', data);
                switch (data.type) {
                    case 'player_join':
                        this.addPlayer(data.playerId, data.ship, false);
                        break;
                    case 'player_update':
                        this.updatePlayer(data.playerId, data);
                        break;
                    case 'bullet_create':
                        this.createBullet(data);
                        break;
                    case 'player_hit':
                        this.handlePlayerHit(data);
                        break;
                }
            }
            
            addPlayer(id, shipIndex, isLocal) {
                const ship = this.ships[shipIndex];
                this.players[id] = {
                    x: isLocal ? 100 : this.canvas.width - 100,
                    y: 400,
                    ship: shipIndex,
                    health: 100,
                    maxHealth: 100,
                    angle: 0,
                    isLocal: isLocal
                };
                
                this.updatePlayerUI();
                console.log('Player added:', id, isLocal ? '(local)' : '(remote)');
            }
            
            updatePlayer(id, data) {
                if (this.players[id] && !this.players[id].isLocal) {
                    this.players[id].x = data.x;
                    this.players[id].y = data.y;
                    this.players[id].angle = data.angle;
                }
            }
            
            update() {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                const localPlayer = Object.values(this.players).find(p => p.isLocal);
                if (localPlayer && this.gameActive) {
                    // –î–≤–∏–∂–µ–Ω–∏–µ
                    const ship = this.ships[localPlayer.ship];
                    if (this.keys['w']) localPlayer.y -= ship.speed;
                    if (this.keys['s']) localPlayer.y += ship.speed;
                    if (this.keys['a']) localPlayer.x -= ship.speed;
                    if (this.keys['d']) localPlayer.x += ship.speed;
                    
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö canvas
                    localPlayer.x = Math.max(30, Math.min(this.canvas.width - 30, localPlayer.x));
                    localPlayer.y = Math.max(30, Math.min(this.canvas.height - 30, localPlayer.y));
                    
                    // –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫ –∫—É—Ä—Å–æ—Ä—É
                    localPlayer.angle = Math.atan2(this.mouse.y - localPlayer.y, this.mouse.x - localPlayer.x);
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É
                    if (this.conn && this.conn.open) {
                        this.sendData({
                            type: 'player_update',
                            x: localPlayer.x,
                            y: localPlayer.y,
                            angle: localPlayer.angle
                        });
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    bullet.x += Math.cos(bullet.angle) * bullet.speed;
                    bullet.y += Math.sin(bullet.angle) * bullet.speed;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
                    let hit = false;
                    for (const playerId in this.players) {
                        const player = this.players[playerId];
                        if (player.isLocal !== bullet.isLocal) {
                            const dx = bullet.x - player.x;
                            const dy = bullet.y - player.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 30) {
                                // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
                                this.handleHit(playerId, bullet);
                                hit = true;
                                break;
                            }
                        }
                    }
                    
                    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–ª—å –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –∏–ª–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ —ç–∫—Ä–∞–Ω
                    if (hit || bullet.x < 0 || bullet.x > this.canvas.width || 
                        bullet.y < 0 || bullet.y > this.canvas.height) {
                        this.bullets.splice(i, 1);
                    }
                }
            }
            
            shoot() {
                if (!this.gameActive) return;
                
                const localPlayer = Object.values(this.players).find(p => p.isLocal);
                if (localPlayer && this.conn && this.conn.open) {
                    const bullet = {
                        x: localPlayer.x + Math.cos(localPlayer.angle) * 20,
                        y: localPlayer.y + Math.sin(localPlayer.angle) * 20,
                        angle: localPlayer.angle,
                        speed: 8,
                        damage: this.ships[localPlayer.ship].attack * 10,
                        isLocal: true
                    };
                    
                    this.bullets.push(bullet);
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—É–ª–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É
                    this.sendData({
                        type: 'bullet_create',
                        ...bullet,
                        isLocal: false
                    });
                }
            }
            
            createBullet(data) {
                this.bullets.push({
                    x: data.x,
                    y: data.y,
                    angle: data.angle,
                    speed: data.speed,
                    damage: data.damage,
                    isLocal: false
                });
            }
            
            handleHit(playerId, bullet) {
                const player = this.players[playerId];
                if (player) {
                    const damage = bullet.damage / this.ships[player.ship].defense;
                    player.health -= damage;
                    player.health = Math.max(0, player.health);
                    
                    this.updatePlayerUI();
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ø–∞–¥–∞–Ω–∏–∏
                    if (this.conn && this.conn.open) {
                        this.sendData({
                            type: 'player_hit',
                            playerId: playerId,
                            damage: damage
                        });
                    }
                    
                    if (player.health <= 0) {
                        this.handlePlayerDeath(playerId);
                    }
                }
            }
            
            handlePlayerHit(data) {
                const player = this.players[data.playerId];
                if (player) {
                    player.health -= data.damage;
                    player.health = Math.max(0, player.health);
                    this.updatePlayerUI();
                    
                    if (player.health <= 0) {
                        this.handlePlayerDeath(data.playerId);
                    }
                }
            }
            
            handlePlayerDeath(playerId) {
                const player = this.players[playerId];
                player.health = player.maxHealth;
                player.x = player.isLocal ? 100 : this.canvas.width - 100;
                player.y = 400;
                
                this.updatePlayerUI();
            }
            
            handleDisconnect() {
                this.updateConnectionStatus('‚ùå –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è', 'status-disconnected');
                this.gameActive = false;
            }
            
            render() {
                // –û—á–∏—Å—Ç–∫–∞ canvas
                this.ctx.fillStyle = 'rgba(10, 10, 42, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
                Object.values(this.players).forEach(player => {
                    const ship = this.ships[player.ship];
                    
                    this.ctx.save();
                    this.ctx.translate(player.x, player.y);
                    this.ctx.rotate(player.angle);
                    
                    // –ö–æ—Ä–∞–±–ª—å
                    this.ctx.fillStyle = ship.color;
                    this.ctx.beginPath();
                    this.ctx.moveTo(20, 0);
                    this.ctx.lineTo(-15, -10);
                    this.ctx.lineTo(-15, 10);
                    this.ctx.closePath();
                    this.ctx.fill();
                    
                    this.ctx.restore();
                    
                    // –•–µ–ª—Å–±–∞—Ä
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    this.ctx.fillRect(player.x - 25, player.y - 40, 50, 5);
                    this.ctx.fillStyle = player.health > 30 ? '#4ecdc4' : '#ff6b6b';
                    this.ctx.fillRect(player.x - 25, player.y - 40, 50 * (player.health / 100), 5);
                });
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É–ª—å
                this.bullets.forEach(bullet => {
                    this.ctx.fillStyle = bullet.isLocal ? '#4ecdc4' : '#ff6b6b';
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }
            
            gameLoop() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }
            
            sendData(data) {
                if (this.conn && this.conn.open) {
                    try {
                        this.conn.send(data);
                    } catch (error) {
                        console.error('Send data error:', error);
                    }
                }
            }
            
            updatePlayerUI() {
                const players = Object.values(this.players);
                const localPlayer = players.find(p => p.isLocal);
                const remotePlayer = players.find(p => !p.isLocal);
                
                if (localPlayer) {
                    document.getElementById('p1Ship').textContent = this.ships[localPlayer.ship].name;
                    document.getElementById('p1Health').style.width = localPlayer.health + '%';
                }
                if (remotePlayer) {
                    document.getElementById('p2Ship').textContent = this.ships[remotePlayer.ship].name;
                    document.getElementById('p2Health').style.width = remotePlayer.health + '%';
                }
            }
            
            generateGameId() {
                return Math.random().toString(36).substr(2, 6).toUpperCase();
            }
            
            showGameArea() {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                this.gameActive = true;
                this.updateConnectionStatus('‚úÖ –ë–∏—Ç–≤–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'status-connected');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const starfield = new Starfield();
        const game = new CosmicShooter();

        // –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞
        function animateStars() {
            starfield.update();
            requestAnimationFrame(animateStars);
        }
        animateStars();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function selectShip(index) {
            document.querySelectorAll('.ship-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.ship-card')[index].classList.add('selected');
            game.selectedShip = index;
        }

        function createGame() {
            game.createGame();
        }

        function showJoinForm() {
            document.getElementById('joinForm').style.display = 'block';
        }

        function joinGame() {
            const code = document.getElementById('gameCodeInput').value.trim();
            if (code) {
                game.joinGame(code);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–≥—Ä—ã!');
            }
        }

        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–æ—Ä–∞–±–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        selectShip(0);
    </script>
</body>
</html>